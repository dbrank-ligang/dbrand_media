<template>
  <div class="mediaDetailBox">
    <div v-html="rawHtml"></div>
    <!-- <div style="background: #fff; padding: 20px">
      <div class="lemmaSummary_jO4rs J-summary">
        <a name="lemma-summary" class="lemmaSummaryAnchor_hwbCj"></a>
        <div class="para_YSJB6 summary_LggeX MARK_MODULE" data-tag="paragraph" data-uuid="gnwl6uzzls" data-idx="">
          <span class="text_S3vZG" data-text="true">
            《证券时报》创立于1993年，是人民日报社主管主办的全国性财经证券类日报，是中国证监会指定披露上市公司信息、
          </span>
          <span class="text_S3vZG" data-text="true">
            <a
              class="innerLink_I4_DN"
              href="https://baike.baidu.com/item/%E7%99%BE%E5%BA%A6%E6%90%9C%E7%B4%A2/22311?fromModule=lemma_inlink"
              target="_blank"
              data-from-module="summary"
              >中国保监会
            </a>
          </span>
          <span class="text_S3vZG" data-text="true">指定披露</span>
          <span class="text_S3vZG" data-text="true">
            <a
              class="innerLink_I4_DN"
              href="/item/%E4%BF%9D%E9%99%A9%E4%BF%A1%E6%81%AF/12747170?fromModule=lemma_inlink"
              target="_blank"
              data-from-module="summary"
              >保险信息
            </a>
          </span>
          <span class="text_S3vZG" data-text="true">、中国银监会指定披露</span>
          <span class="text_S3vZG" data-text="true">
            <a
              class="innerLink_I4_DN"
              href="/item/%E4%BF%A1%E6%89%98%E5%85%AC%E5%8F%B8/94434?fromModule=lemma_inlink"
              target="_blank"
              data-from-module="summary"
              >信托公司
            </a>
          </span>
          <span class="text_S3vZG" data-text="true">信息的报刊。</span>
        </div>
        <div class="para_YSJB6 summary_LggeX MARK_MODULE" data-tag="paragraph" data-uuid="gnwl6y9hwa" data-idx="">
          <span class="text_S3vZG" data-text="true">该报以报道</span>
          <span class="text_S3vZG" data-text="true">
            <a
              class="innerLink_I4_DN"
              href="/item/%E8%AF%81%E5%88%B8%E5%B8%82%E5%9C%BA/2986895?fromModule=lemma_inlink"
              target="_blank"
              data-from-module="summary"
              >证券市场
            </a>
          </span>
          <span class="text_S3vZG" data-text="true">为主，兼顾经济</span>
          <span class="text_S3vZG" data-text="true">
            <a
              class="innerLink_I4_DN"
              href="/item/%E9%87%91%E8%9E%8D%E4%BF%A1%E6%81%AF/5280170?fromModule=lemma_inlink"
              target="_blank"
              data-from-module="summary"
              >金融信息
            </a>
          </span>
          <span class="text_S3vZG" data-text="true">，面向国内外</span>
          <span class="text_S3vZG" data-text="true">
            <a
              class="innerLink_I4_DN"
              href="https://baike.baidu.com/item/%E4%BF%9D%E9%99%A9%E4%BF%A1%E6%81%AF/12747170?fromModule=lemma_inlink"
              target="_blank"
              data-from-module="summary"
              >公开发行
            </a>
          </span>
          <span class="text_S3vZG" data-text="true">。</span>
        </div>
      </div>
      <div class="basicInfo_O1Zot J-basic-info">
        <dl class="basicInfoBlock_mxixf left">
          <div class="itemWrapper_uuTI3">
            <dt class="basicInfoItem_kkuIl itemName_JAwrE">中文名</dt>
            <dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">证券时报</span></dd>
          </div>
          <div class="itemWrapper_uuTI3">
            <dt class="basicInfoItem_kkuIl itemName_JAwrE">外文名</dt>
            <dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">Securities Times</span></dd>
          </div>
          <div class="itemWrapper_uuTI3">
            <dt class="basicInfoItem_kkuIl itemName_JAwrE">主管单位</dt>
            <dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">人民日报社</span></dd>
          </div>
          <div class="itemWrapper_uuTI3">
            <dt class="basicInfoItem_kkuIl itemName_JAwrE">主办单位</dt>
            <dd class="basicInfoItem_kkuIl itemValue_zVpWC">
              <span class="text_S3vZG" data-text="true">
                <a
                  class="innerLink_I4_DN"
                  href="/item/%E4%BA%BA%E6%B0%91%E6%97%A5%E6%8A%A5%E7%A4%BE/640119?fromModule=lemma_inlink"
                  target="_blank"
                  data-from-module="basicInfo"
                  >人民日报社
                </a>
              </span>
            </dd>
          </div>
          <div class="itemWrapper_uuTI3">
            <dt class="basicInfoItem_kkuIl itemName_JAwrE">创刊时间</dt>
            <dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">1993年</span></dd>
          </div>
        </dl>
        <dl class="basicInfoBlock_mxixf right">
          <div class="itemWrapper_uuTI3">
            <dt class="basicInfoItem_kkuIl itemName_JAwrE">出版周期</dt>
            <dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">一周六报</span></dd>
          </div>
          <div class="itemWrapper_uuTI3">
            <dt class="basicInfoItem_kkuIl itemName_JAwrE">国内刊号</dt>
            <dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">CN44-0157</span></dd>
          </div>
          <div class="itemWrapper_uuTI3">
            <dt class="basicInfoItem_kkuIl itemName_JAwrE">邮发代号</dt>
            <dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">45-91</span></dd>
          </div>
          <div class="itemWrapper_uuTI3">
            <dt class="basicInfoItem_kkuIl itemName_JAwrE">编辑出版</dt>
            <dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">证券时报社</span></dd>
          </div>
          <div class="itemWrapper_uuTI3">
            <dt class="basicInfoItem_kkuIl itemName_JAwrE">刊物类别</dt>
            <dd class="basicInfoItem_kkuIl itemValue_zVpWC">
              <span class="text_S3vZG" data-text="true">时报 对开不少于12版</span>
            </dd>
          </div>
        </dl>
      </div>
    </div> -->
    <div class="mediaDetail_left">
      <div class="left_top">
        <div class="left_top_tit1" style="">[统一归类名称]</div>
        <div class="left_top_tit2">{{ oneLevelObj.unionMediaName }}</div>
        <div class="left_top_tit3" style="margin-top: 20px">网站:{{ oneLevelObj.url }}</div>
        <div class="left_top_tit3">客户端: {{ oneLevelObj.client }}</div>
        <div class="left_top_tit3">电子报: {{ oneLevelObj.epaper }}</div>
      </div>
      <ul class="left_bottom">
        <li
          v-for="item in oneLevelObj.mediaList"
          :key="item.mediaId"
          :class="{ active: oneLevelActiveId == item.mediaId }"
          @click="oneLevelClick(item)"
        >
          <div class="mediaName_nav"><span></span>{{ item.mediaName }}</div>
          <div
            v-if="oneLevelActiveId == item.mediaId && (item.beforeName || item.anotherName || item.includeName)"
            style="min-height: 50px; font-size: 14px"
          >
            {{
              (item.beforeName ? item.beforeName + "&" : "") +
              (item.anotherName ? item.anotherName + "&" : "") +
              (item.includeName ? item.includeName : "")
            }}
          </div>
        </li>
      </ul>
    </div>
    <div class="mediaDetail_right">
      <div class="mediaSource">
        <div class="mediaSource_tit">[作为媒体源]</div>
        <div class="mediaSource_listBox">
          <div class="mediaSource_listRow" v-for="(item, i) in mediaSourceArr" :key="item.name">
            <div class="mediaSource_rowTit">[{{ item.name }}]</div>
            <div class="mediaSource_rowCon">
              <div
                v-for="mediaItem in item.data"
                :key="mediaItem.name"
                @click="mediaSourceItemClick(mediaItem, i)"
                :class="{ activeMedia: activeMediaSourceIndex === i + mediaItem.name }"
              >
                {{ mediaItem.name }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mediaSource" style="margin-top: 10px">
        <div class="mediaSource_tit">[账号列表]</div>
        <div class="mediaSource_listBox">
          <div class="mediaSource_listRow">
            <div class="mediaSource_rowCon">
              <div
                v-for="(item, index) in numberArr"
                :key="item.id"
                @click="accountClick(index, item)"
                :class="{ activeNumber: activeNumberIndex == index }"
              >
                {{ item.accountName }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="numberDetailBox" style="margin-top: 10px">
        <div class="numberDetailBox_tit">[账号详情]</div>
        <div style="padding: 15px 0 15px 15px">
          <div class="numberDetailBox_Row" v-for="item in Object.keys(numberDetailObj?.extendFields)" :key="item">
            <div class="numberDetailBox_rowTit">{{ item }}：</div>
            <div class="numberDetailBox_rowCon">{{ numberDetailObj?.extendFields[item] }}</div>
          </div>
        </div>
      </div>

      <div class="numberDetailBox" style="margin-top: 10px">
        <div class="numberDetailBox_tit">[账号标签]</div>
        <div style="padding: 15px 0 15px 15px">
          <div class="numberDetailBox_Row">
            <div class="numberDetailBox_rowTit">行业大类标签：</div>
            <div class="numberDetailBox_rowCon">{{ numberDetailObj?.hangyedalei || "" }}</div>
            <div class="numberDetailBox_rowTit">行业二级标签：</div>
            <div class="numberDetailBox_rowCon">{{ numberDetailObj?.hangyeerji || "" }}</div>
          </div>
          <div class="numberDetailBox_Row">
            <div class="numberDetailBox_rowTit">行业二级标签：</div>
            <div class="numberDetailBox_rowCon">{{ numberDetailObj?.hangyeerji || "" }}</div>
          </div>
          <div class="numberDetailBox_Row">
            <div class="numberDetailBox_rowTit">内容属性标签：</div>
            <div class="numberDetailBox_rowCon">{{ numberDetailObj?.neirongshuxing || "" }}</div>
          </div>
          <div class="numberDetailBox_Row">
            <div class="numberDetailBox_rowTit">媒体属性标签：</div>
            <div class="numberDetailBox_rowCon">{{ numberDetailObj?.meitishuxing || "" }}</div>
          </div>
          <div class="numberDetailBox_Row">
            <div class="numberDetailBox_rowTit">其他标签：</div>
            <div class="numberDetailBox_rowCon">{{ numberDetailObj?.qita || "" }}</div>
          </div>
        </div>
      </div>

      <div class="contentListBox" style="margin-top: 10px">
        <div class="contentListBox_tit">{{ oneName }} / {{ twoName }} / {{ threeName }}</div>
        <div style="margin-top: 30px">
          [内容列表]
          <el-date-picker
            v-model="dateArr"
            type="daterange"
            range-separator="至"
            start-placeholder="开始时间"
            end-placeholder="结束时间"
            size="small"
            @change="changeDate"
          />
        </div>
        <el-table :data="articlesArr" height="250" style="width: 100%" class="tableBox">
          <el-table-column prop="brandName" label="高相关品牌" />
          <el-table-column label="内容标题">
            <template #default="scope">
              <a target="_blank" :href="scope.row.docUrl">{{ scope.row.title }}</a>
            </template>
          </el-table-column>
          <el-table-column label="发表时间">
            <template #default="scope">
              {{ timestampToDate(scope.row.publishTime) }}
            </template>
          </el-table-column>
        </el-table>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts" name="mediaDetail">
import { ref, onMounted } from "vue";
import { useRoute } from "vue-router";
import { mediaNavApi, accountListApi, accountApi, articlesApi } from "@/api/modules/media";
import { isArray } from "@/utils/is";

const rawHtml = ref(
  `<div class="lemmaSummary_jO4rs J-summary"><a name="lemma-summary" class="lemmaSummaryAnchor_hwbCj"></a><div class="para_YSJB6 summary_LggeX MARK_MODULE" data-tag="paragraph" data-uuid="gnwl6uzzls" data-idx=""><span class="text_S3vZG" data-text="true">《证券时报》创立于1993年，是人民日报社主管主办的全国性财经证券类日报，是中国证监会指定披露上市公司信息、</span><span class="text_S3vZG" data-text="true"><a class="innerLink_I4_DN" href="https://baike.baidu.com/item/%E7%99%BE%E5%BA%A6%E6%90%9C%E7%B4%A2/22311?fromModule=lemma_inlink" target="_blank" data-from-module="summary">中国保监会</a></span><span class="text_S3vZG" data-text="true">指定披露</span><span class="text_S3vZG" data-text="true"><a class="innerLink_I4_DN" href="/item/%E4%BF%9D%E9%99%A9%E4%BF%A1%E6%81%AF/12747170?fromModule=lemma_inlink" target="_blank" data-from-module="summary">保险信息</a></span><span class="text_S3vZG" data-text="true">、中国银监会指定披露</span><span class="text_S3vZG" data-text="true"><a class="innerLink_I4_DN" href="/item/%E4%BF%A1%E6%89%98%E5%85%AC%E5%8F%B8/94434?fromModule=lemma_inlink" target="_blank" data-from-module="summary">信托公司</a></span><span class="text_S3vZG" data-text="true">信息的报刊。</span></div><div class="para_YSJB6 summary_LggeX MARK_MODULE" data-tag="paragraph" data-uuid="gnwl6y9hwa" data-idx=""><span class="text_S3vZG" data-text="true">该报以报道</span><span class="text_S3vZG" data-text="true"><a class="innerLink_I4_DN" href="/item/%E8%AF%81%E5%88%B8%E5%B8%82%E5%9C%BA/2986895?fromModule=lemma_inlink" target="_blank" data-from-module="summary">证券市场</a></span><span class="text_S3vZG" data-text="true">为主，兼顾经济</span><span class="text_S3vZG" data-text="true"><a class="innerLink_I4_DN" href="/item/%E9%87%91%E8%9E%8D%E4%BF%A1%E6%81%AF/5280170?fromModule=lemma_inlink" target="_blank" data-from-module="summary">金融信息</a></span><span class="text_S3vZG" data-text="true">，面向国内外</span><span class="text_S3vZG" data-text="true"><a class="innerLink_I4_DN" href="/item/%E5%85%AC%E5%BC%80%E5%8F%91%E8%A1%8C/266659?fromModule=lemma_inlink" target="_blank" data-from-module="summary">公开发行</a></span><span class="text_S3vZG" data-text="true">。</span></div></div><div class="basicInfo_O1Zot J-basic-info"><dl class="basicInfoBlock_mxixf left"><div class="itemWrapper_uuTI3"><dt class="basicInfoItem_kkuIl itemName_JAwrE">中文名</dt><dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">证券时报</span></dd></div><div class="itemWrapper_uuTI3"><dt class="basicInfoItem_kkuIl itemName_JAwrE">外文名</dt><dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">Securities Times</span></dd></div><div class="itemWrapper_uuTI3"><dt class="basicInfoItem_kkuIl itemName_JAwrE">主管单位</dt><dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">人民日报社</span></dd></div><div class="itemWrapper_uuTI3"><dt class="basicInfoItem_kkuIl itemName_JAwrE">主办单位</dt><dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true"><a class="innerLink_I4_DN" href="/item/%E4%BA%BA%E6%B0%91%E6%97%A5%E6%8A%A5%E7%A4%BE/640119?fromModule=lemma_inlink" target="_blank" data-from-module="basicInfo">人民日报社</a></span></dd></div><div class="itemWrapper_uuTI3"><dt class="basicInfoItem_kkuIl itemName_JAwrE">创刊时间</dt><dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">1993年</span></dd></div></dl><dl class="basicInfoBlock_mxixf right"><div class="itemWrapper_uuTI3"><dt class="basicInfoItem_kkuIl itemName_JAwrE">出版周期</dt><dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">一周六报</span></dd></div><div class="itemWrapper_uuTI3"><dt class="basicInfoItem_kkuIl itemName_JAwrE">国内刊号</dt><dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">CN44-0157</span></dd></div><div class="itemWrapper_uuTI3"><dt class="basicInfoItem_kkuIl itemName_JAwrE">邮发代号</dt><dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">45-91</span></dd></div><div class="itemWrapper_uuTI3"><dt class="basicInfoItem_kkuIl itemName_JAwrE">编辑出版</dt><dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">证券时报社</span></dd></div><div class="itemWrapper_uuTI3"><dt class="basicInfoItem_kkuIl itemName_JAwrE">刊物类别</dt><dd class="basicInfoItem_kkuIl itemValue_zVpWC"><span class="text_S3vZG" data-text="true">时报 对开不少于12版</span></dd></div></dl></div>`
);
const route = useRoute();
// 左侧一级导航列表数据
const oneLevelObj = ref({
  unionMediaId: null, //    媒体集群id
  unionMediaName: null, //    媒体集群名称
  url: null,
  client: null,
  epaper: null,
  mediaList: []
} as any);
let activeMediaSourceIndex = ref(0); // 媒体源，默认选中第一个
const activeNumberIndex = ref(0); // 账号列表，默认选中第一个
const accountId = ref(null); // 账号列表选中的id
const oneName = ref("一级"); // 一级选中的
const twoName = ref("二级"); // 二级选中的
const threeName = ref("三级"); // 三级选中的

let dateArr = ref([]); // 时间选择器
const defaultObj = ref({
  mediaId: null,
  mediaName: null,
  platform: null,
  accountName: null
} as any);

//媒体源、账号列表
const mediaSourceArr = ref([] as any);
let numberArr = ref([] as any); //账号列表
// 账号详情、账号标签
let numberDetailObj = ref({
  extendFields: {},
  hangyedalei: null,
  neirongshuxing: null,
  meitishuxing: null,
  hangyeerji: null,
  qita: null
} as any);
const articlesArr = ref([] as any);
const oneLevelActiveId = ref(); // 左侧列表 选中的id
// // 左侧列表点击事件
function oneLevelClick(item) {
  oneLevelActiveId.value = item.mediaId;
  getMdiaSourceArr({ mediaId: item.mediaId }); //获取媒体源、账号列表
  console.log("一级菜单栏选中的：", item.mediaName);
  oneName.value = item.mediaName;
}
// 切换媒体源
function mediaSourceItemClick(mediaItem, i) {
  activeNumberIndex.value = 0;
  activeMediaSourceIndex.value = i + mediaItem.name; // 点击时更新当前活动索引
  getAccountList(mediaItem);
  twoName.value = mediaItem.name;
  // console.log(numberArr.value);
}
// 点击账号
function accountClick(index: any, item: any) {
  activeNumberIndex.value = index; // 点击时更新当前
  threeName.value = item.accountName; // 选中账号的name
  accountId.value = item.id; // 选中账号的id
  getAccountObj(item.id);
}
const changeDate = () => {
  // console.log(dateArr.value[0]); // 开始时间
  // console.log(dateArr.value[1]); // 结束时间
  const startTime = new Date(dateArr.value[0]).getTime() / 1000;
  const endTime = new Date(dateArr.value[1]).getTime() / 1000;
  // console.log(new Date(startTime).getTime(), new Date(endTime).getTime());
  getAarticlesList({ startTime, endTime });
};
// 时间戳转换为日期的函数
const timestampToDate = timestamp => {
  const date = new Date(timestamp);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
};
// 媒体一级列表
const getOneLevelArr = async (params: any) => {
  const { data } = await mediaNavApi(params);
  oneLevelObj.value = data as any;
  // 找到url中mediaId对应的item
  let selectItem = {};
  for (let i = 0; i < oneLevelObj.value.mediaList.length; i++) {
    let item = oneLevelObj.value.mediaList[i];
    if (item.mediaId == defaultObj.value.mediaId) {
      selectItem = item;
    }
  }
  oneLevelClick(selectItem);
};

// 获取媒体源列表
const getMdiaSourceArr = async (params: any) => {
  const { data } = await accountListApi(params);
  mediaSourceArr.value = data as any;

  let mediaSourceItem = {};
  let selectIndex = 0;

  if (defaultObj.value?.platform) {
    // 账号、媒体查询页 跳进来后，找到对应的item
    for (let i = 0; i < mediaSourceArr.value.length; i++) {
      let tempData = mediaSourceArr.value[i];
      for (let j = 0; j < tempData.data.length; j++) {
        console.log(tempData.data[j]);
        if (tempData.data[j].name === defaultObj.value.platform) {
          mediaSourceItem = tempData.data[j];
          selectIndex = i;
          defaultObj.value.platform = null;
        }
      }
    }
  } else {
    if (isArray(mediaSourceArr.value) && mediaSourceArr.value.length > 0) {
      selectIndex = 0;
      let obj = mediaSourceArr.value[0];
      if (isArray(obj.data) && obj.data.length > 0) {
        mediaSourceItem = obj.data[0];
      }
    }
  }
  mediaSourceItemClick(mediaSourceItem, selectIndex); // 传入点击的item 及 第几行
};

// 获取账户列表
const getAccountList = mediaItem => {
  numberArr.value = mediaItem.data;
  // 设置账户列表默认选中
  if (isArray(numberArr.value) && numberArr.value.length > 0) {
    if (defaultObj.value.accountName) {
      for (let i = 0; i < numberArr.value.length; i++) {
        if (defaultObj.value.accountName == numberArr.value[i].accountName) {
          accountClick(i, numberArr.value[i]);
          defaultObj.value.accountName = null;
        }
      }
    } else {
      accountClick(0, numberArr.value[0]);
    }
  }
};

// 查询账号详情（根据账号列表选中的id）
const getAccountObj = async (params: any) => {
  const { data } = await accountApi({ accountId: params });
  numberDetailObj.value = data as any;
};
// 查询账号详情（根据账号列表选中的id）
const getAarticlesList = async (params: any) => {
  const { data } = await articlesApi({ startTime: params.startTime, endTime: params.endTime, accountId: accountId.value });
  articlesArr.value = data as any;
};

onMounted(() => {
  const myParam = route.query;
  defaultObj.value = myParam;
  console.log(defaultObj.value); // 输出查询参数的值
  getOneLevelArr({ mediaId: defaultObj.value.mediaId }); // 获取左侧导航列表
});
</script>
<style lang="scss">
@import "./baike.scss";
</style>
<style scoped lang="scss">
@import "./index.scss";
</style>
